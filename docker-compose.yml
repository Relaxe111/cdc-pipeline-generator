services:
  dev:
    image: asmacarma/cdc-pipeline-generator:latest
    hostname: test-2-dev
    container_name: test-2-dev
    volumes:
    - .:/workspace
    - ~/.ssh:/root/.ssh:ro
    - ~/.gitconfig:/root/.gitconfig:ro
    environment:
      PYTHONPATH: /workspace
    working_dir: /workspace
    stdin_open: true
    tty: true
    command: fish
    networks:
    - cdc-network
    depends_on:
    - postgres-source
    - postgres-target
  postgres:
    image: postgres:17-alpine
    hostname: test-2-postgres
    container_name: test-2-replica
    ports:
    - ${POSTGRES_PORT:-5432}:5432
    environment:
      POSTGRES_USER: ${POSTGRES_LOCAL_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_LOCAL_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_LOCAL_DB:-test-2_db}
    volumes:
    - postgres-data:/var/lib/postgresql/data
    - ./scripts/postgres-init:/docker-entrypoint-initdb.d
    networks:
    - cdc-network
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U postgres
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
    - local-sink
    - full
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    hostname: test-2-redpanda
    container_name: test-2-redpanda
    command:
    - redpanda
    - start
    - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
    - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
    - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
    - --advertise-pandaproxy-addr internal://redpanda:8082,external://localhost:18082
    - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081
    - --rpc-addr redpanda:33145
    - --advertise-rpc-addr redpanda:33145
    - --smp 1
    - --memory 1G
    - --mode dev-container
    - --default-log-level=info
    ports:
    - 18081:18081
    - 18082:18082
    - 19092:19092
    - 19644:9644
    networks:
    - cdc-network
    healthcheck:
      test:
      - CMD-SHELL
      - rpk cluster health | grep -E 'Healthy:.+true' || exit 1
      interval: 15s
      timeout: 3s
      retries: 5
      start_period: 5s
  console:
    image: docker.redpanda.com/redpandadata/console:latest
    hostname: test-2-console
    container_name: test-2-console
    entrypoint: /bin/sh
    command: -c 'echo "$$CONSOLE_CONFIG_FILE" > /tmp/config.yml; /app/console'
    environment:
      CONFIG_FILEPATH: /tmp/config.yml
      CONSOLE_CONFIG_FILE: "kafka:\n  brokers: [\"redpanda:9092\"]\n  schemaRegistry:\n\
        \    enabled: true\n    urls: [\"http://redpanda:8081\"]\nredpanda:\n  adminApi:\n\
        \    enabled: true\n    urls: [\"http://redpanda:9644\"]\n"
    ports:
    - 8080:8080
    networks:
    - cdc-network
    depends_on:
    - redpanda
  adminer:
    image: adminer:latest
    hostname: test-2-adminer
    container_name: test-2-adminer
    ports:
    - 8090:8080
    environment:
      ADMINER_DEFAULT_SERVER: postgres
    networks:
    - cdc-network
  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    hostname: test-2-mssql
    container_name: test-2-mssql
    profiles:
    - local-source
    - full
    environment:
      ACCEPT_EULA: Y
      MSSQL_SA_PASSWORD: ${MSSQL_SA_PASSWORD:-YourStrong!Passw0rd}
      MSSQL_PID: Developer
      MSSQL_AGENT_ENABLED: 'true'
    ports:
    - ${MSSQL_PORT:-1433}:1433
    volumes:
    - mssql-data:/var/opt/mssql
    - ./scripts/mssql-init:/docker-entrypoint-initdb.d
    networks:
    - cdc-network
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "${MSSQL_SA_PASSWORD:-YourStrong!Passw0rd}"
        -Q "SELECT 1" -b -o /dev/null
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 10s
  postgres-target:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_TARGET_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_TARGET_PASSWORD}
      POSTGRES_DB: ${POSTGRES_TARGET_DB:-cdc_target}
    ports:
    - ${POSTGRES_TARGET_PORT:-5432}:5432
    volumes:
    - postgres-target-data:/var/lib/postgresql/data
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U ${POSTGRES_USER:-postgres}
      interval: 10s
      timeout: 3s
      retries: 5
networks:
  cdc-network:
    name: test-2-network
    driver: bridge
volumes:
  postgres-data:
    name: test-2-postgres-data
  mssql-data:
    name: test-2-mssql-data
  postgres-target-data: null
