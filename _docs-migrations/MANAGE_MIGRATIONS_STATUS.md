# Manage Migrations â€” Status Audit

> **Temporary working document.** Will be refined and moved to `_docs/` when migration work is complete.
>
> Audit date: 2026-02-26
>
> **Implementation plan:** [MIGRATION_IMPLEMENTATION_PLAN.md](MIGRATION_IMPLEMENTATION_PLAN.md) â€” tracks phases, tasks, and progress for fixing all gaps identified here.

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Current CLI Surface](#2-current-cli-surface)
3. [Generated Artifacts Map](#3-generated-artifacts-map)
4. [Audit: Service Config Awareness](#4-audit-service-config-awareness)
5. [Audit: Versioning & Schema Evolution](#5-audit-versioning--schema-evolution)
6. [Audit: Staging / Unlogged Table Generation](#6-audit-staging--unlogged-table-generation)
7. [Audit: Flags (target_exists, replicate_structure)](#7-audit-flags-target_exists-replicate_structure)
8. [Audit: Offset Gap Setup](#8-audit-offset-gap-setup)
9. [Audit: Target Schema Creation](#9-audit-target-schema-creation)
10. [Pattern Comparison (db-per-tenant vs db-shared)](#10-pattern-comparison-db-per-tenant-vs-db-shared)
11. [Best-Practice Recommendations](#11-best-practice-recommendations)
12. [Action Plan](#12-action-plan)

---

## 1. Executive Summary

**Overall status: ðŸ”´ Migration generation is non-functional.**

The old `scripts/2-apply-cdc-tables.py` script â€” which generated all `pg-migrations/*.sql` files â€” was **deleted** during the project restructuring but **never migrated** into `cdc_generator/`. The existing SQL files in `generated/pg-migrations/` are **stale artifacts** from the last manual run (2026-01-29).

| Aspect | Status | Details |
|--------|--------|---------|
| CLI commands registered | âš ï¸ Partial | 4 subcommands in Click, but only 1 (`schema-docs`) routed in `MIGRATION_COMMANDS` |
| Migration SQL generation | ðŸ”´ Missing | No code in `cdc_generator/` writes to `generated/pg-migrations/` |
| Table-definition generation | ðŸ”´ Missing | No code regenerates `generated/table-definitions/*.yaml` from MSSQL |
| Service config awareness | ðŸ”´ None | Generated migrations cover 3 tables; service config has 39 source tables |
| Versioning / schema evolution | ðŸ”´ None | No version tracking, no diff, no incremental ALTER |
| Staging table generation | ðŸŸ¡ Stale | SQL exists for 3 tables, but not auto-generated from current config |
| Flag handling (`target_exists`, `replicate_structure`) | ðŸ”´ Not connected | Flags exist in service config & types but are not consumed by migration gen |
| Offset gap setup | ðŸŸ¡ Partial | `cdc_processing_log` SQL exists, but not auto-generated per table |
| Target schema creation | ðŸŸ¡ Stale | `1-create-customer-schemas.sql` exists but was manually generated |

---

## 2. Current CLI Surface

> **Plan:** [Phase 0 â€” CLI Cleanup](MIGRATION_IMPLEMENTATION_PLAN.md#phase-0-cli-cleanup)

### 2.1 Registered Subcommands

File: `cdc_generator/cli/click_commands.py` (lines 1334â€“1420)

| Subcommand | Click registered | In `MIGRATION_COMMANDS` dict | Actual module | Status |
|-----------|:--:|:--:|-----------|--------|
| `schema-docs` | âœ… | âœ… | `cdc_generator.cli.schema_docs` | âœ… Works â€” inspects MSSQL, outputs YAML to `generated/schemas/` |
| `enable-cdc` | âœ… | âŒ | *(none)* | ðŸ”´ **Will fail** â€” "Unknown subcommand" at runtime |
| `apply-replica` | âœ… | âŒ | *(none)* | ðŸ”´ **Will fail** â€” "Unknown subcommand" at runtime |
| `clean-cdc` | âœ… | âŒ | *(none)* | ðŸ”´ **Will fail** â€” "Unknown subcommand" at runtime |

### 2.2 Routing Issue

`click_commands.py` registers Click subcommands that passthrough to `execute_grouped_command()`.
That function looks up `MIGRATION_COMMANDS` dict in `commands.py` â€” which only contains `schema-docs`.
Result: `enable-cdc`, `apply-replica`, `clean-cdc` all fail silently with "Unknown subcommand".

### 2.3 What `schema-docs` Actually Does

File: `cdc_generator/cli/schema_docs.py`

- Connects to MSSQL reference database
- Introspects all `dbo.*` tables (columns, PKs, FKs)
- Writes YAML to `generated/schemas/{database}.{schema}.yaml`
- Does **NOT** generate SQL migrations
- Does **NOT** update `generated/table-definitions/`

---

## 3. Generated Artifacts Map

> **Plan:** [Phase 1 â€” Core Migration Generator](MIGRATION_IMPLEMENTATION_PLAN.md#phase-1-core-migration-generator)

### 3.1 Current Files in `generated/pg-migrations/`

| File | Purpose | Generated by | Current state |
|------|---------|-------------|---------------|
| `0-cdc-merge-control.sql` | CDC merge control system (schema, tables, triggers, views) | Old `scripts/2-apply-cdc-tables.py` | âœ… Complete but static |
| `1-create-customer-schemas.sql` | `CREATE SCHEMA IF NOT EXISTS` for 26 customers | Old script | ðŸŸ¡ Static â€” won't adapt to new customers |
| `2-cdc-processing-log.sql` | Offset tracking, gap detection, replication lag views | Old script | âœ… Complete but uses `{{SCHEMA}}` placeholder |
| `3-Actor.sql` | Final table DDL for Actor | Old script (MSSQL inspection) | âš ï¸ One of only 3 tables generated |
| `3-Fraver.sql` | Final table DDL for Fraver | Old script | âš ï¸ One of only 3 tables generated |
| `3-Test.sql` | Final table DDL for Test | Old script | âš ï¸ Test table â€” may not be needed |
| `4-Actor-staging.sql` | UNLOGGED staging table + merge procedure for Actor | Old script | âš ï¸ Complex, correct but static |
| `4-Fraver-staging.sql` | UNLOGGED staging table + merge procedure for Fraver | Old script | âš ï¸ Complex, correct but static |
| `4-Test-staging.sql` | UNLOGGED staging table + merge procedure for Test | Old script | âš ï¸ May not be needed |

### 3.2 Current Files in `generated/table-definitions/`

| File | Content |
|------|---------|
| `Actor.yaml` | MSSQLâ†’PostgreSQL field mapping, types, PK, topic format |
| `Fraver.yaml` | Same structure |
| `Test.yaml` | Same structure |

**Gap:** Service config has **39 source tables** but only **3 have table-definitions/migrations**.

### 3.3 Agreed Target Structure

> **Decision (2026-02-26):** Move from `generated/pg-migrations/` to top-level `migrations/` with subdirectories by category.

```
# OLD (stale, to be removed)
generated/pg-migrations/
â”œâ”€â”€ 0-cdc-merge-control.sql
â”œâ”€â”€ 1-create-customer-schemas.sql
â”œâ”€â”€ ...

# NEW (canonical target)
migrations/                        â† manage-migrations output root
â”œâ”€â”€ infrastructure/                #   Run once per database
â”‚   â”œâ”€â”€ cdc-merge-control.sql      #     Merge control system
â”‚   â””â”€â”€ cdc-processing-log.sql     #     Offset tracking / gap detection
â”œâ”€â”€ schemas/                       #   CREATE SCHEMA per customer/service
â”‚   â””â”€â”€ create-schemas.sql         #     Auto-generated from source-groups/service config
â”œâ”€â”€ tables/                        #   CREATE TABLE per CDC table
â”‚   â”œâ”€â”€ Actor.sql                  #     Uses {{SCHEMA}} placeholder
â”‚   â”œâ”€â”€ Fraver.sql
â”‚   â””â”€â”€ ...                        #     One file per source table
â””â”€â”€ staging/                       #   UNLOGGED staging + merge procedures
    â”œâ”€â”€ Actor-staging.sql
    â”œâ”€â”€ Fraver-staging.sql
    â””â”€â”€ ...                        #     One file per source table
```

**Rationale:**
- Each `manage-*` CLI group owns a clear top-level folder in implementations
- `manage-services` â†’ `services/`, `manage-pipelines` â†’ `generated/pipelines/`, `manage-migrations` â†’ `migrations/`
- Subdirectories by category scale better than flat numbered prefixes (39+ tables)
- `generated/table-definitions/` stays under `generated/` as intermediate build artifact used by both pipelines and migrations

### 3.4 Placeholder System

SQL files use `{{SCHEMA}}` placeholder, replaced at deployment time per customer.
This is correct for `db-per-tenant` (1 schema per customer), but the replacement logic was in the deleted script.

---

## 4. Audit: Service Config Awareness

> **Plan:** [Phase 2 â€” Service Config Integration](MIGRATION_IMPLEMENTATION_PLAN.md#phase-2-service-config-integration)

### 4.1 Does migration generation consider the current service structure?

**ðŸ”´ No.** There is a complete disconnect:

| Service Config (`services/adopus.yaml`) | Generated Migrations |
|----------------------------------------|---------------------|
| 39 source tables under `source.tables` | 3 tables have migrations |
| Sink config with `target_exists`, `replicate_structure`, `column_templates`, `transforms` | Not read by any migration code |
| Multiple sink targets (e.g., `sink_asma.directory`) | Not considered at all |

### 4.2 What the service config defines that migrations should consume

```yaml
adopus:
  source:
    validation_database: AdOpusTest     # â† MSSQL reference for schema inspection
    tables:                             # â† 39 source tables
      dbo.Actor:
        ignore_columns: [DÃ¸v, FÃ¸deland] # â† Should exclude columns from migration DDL
      dbo.ActorActor: {}
      # ... 37 more tables

  sinks:
    sink_asma.directory:
      tables:
        adopus.Actor:                   # â† Sink table config
          target_exists: false          # â† Table needs to be created
          replicate_structure: true     # â† Clone from source schema
          column_templates:
            - template: customer_id     # â† Extra column to add
          from: dbo.Actor               # â† Source table mapping
        public.customer_user:           # â† Different table
          target_exists: true           # â† Table already exists, just map columns
          columns:                      # â† Column rename mapping
            BrukerNavn: brukerBrukerNavn
```

### 4.3 Expected Behavior

Migration generation SHOULD:
1. Read source tables from `source.tables` to know what to inspect
2. Read `ignore_columns` to exclude from DDL
3. Read sink table configs to know WHERE tables go and HOW
4. Use `target_exists: false` + `replicate_structure: true` â†’ generate CREATE TABLE DDL
5. Use `target_exists: true` â†’ skip DDL (table already exists in target)
6. Apply `column_templates` â†’ add extra columns to DDL
7. Generate staging tables + merge procedures for each CDC table

---

## 5. Audit: Versioning & Schema Evolution

> **Plan:** [Phase 3 â€” Schema Evolution](MIGRATION_IMPLEMENTATION_PLAN.md#phase-3-schema-evolution)

### 5.1 Current State

**ðŸ”´ No versioning exists.** There is:

- No migration version numbering scheme (the `0-`, `1-`, `2-`, `3-`, `4-` prefixes are category prefixes, not versions)
- No tracking of which migrations have been applied
- No incremental `ALTER TABLE` generation for schema changes
- No diff comparison between source schema and existing target schema
- No rollback mechanism
- No migration history table in target databases

### 5.2 What Happens When a Source Table Changes

Currently: **Nothing automated.** The operator must:
1. Manually ALTER the target table
2. Manually update the staging table
3. Manually update the merge procedure
4. Hope they didn't miss a column

### 5.3 Schema Evolution Scenarios Not Handled

| Scenario | Current Handling |
|----------|-----------------|
| New column added to source | âŒ Not detected, not migrated |
| Column type changed in source | âŒ Not detected |
| Column removed from source | âŒ Not detected |
| New table added to service | âŒ Must manually create DDL |
| Primary key changed | âŒ Not detected |
| New column added to `ignore_columns` | âŒ Not detected |
| New customer added | âŒ Must manually edit `1-create-customer-schemas.sql` |

---

## 6. Audit: Staging / Unlogged Table Generation

> **Plan:** [Phase 1E â€” Staging Table + Merge Procedure](MIGRATION_IMPLEMENTATION_PLAN.md#1e-staging-table--merge-procedure-generation)

### 6.1 Current State

**ðŸŸ¡ Partially implemented but stale.**

The existing staging SQL (`4-*-staging.sql`) is well-designed:

- âœ… UNLOGGED tables (no WAL overhead)
- âœ… `autovacuum_enabled = false` (TRUNCATE after merge, no vacuum)
- âœ… Kafka metadata columns (`__kafka_offset`, `__kafka_partition`, `__kafka_timestamp`)
- âœ… Batch merge procedures with `DISTINCT ON` dedup
- âœ… Processing log integration (offset tracking)
- âœ… TRUNCATE after successful merge

**Problems:**
- âŒ Only 3 tables have staging SQL (39 in service config)
- âŒ Not auto-generated from current config
- âŒ The pipeline generator (`helpers_batch.py`) generates staging INSERT YAML that references `stg_*` tables â€” but the DDL to create them doesn't exist for most tables

### 6.2 Pipeline vs Migration Gap

`helpers_batch.py::build_staging_case()` generates Redpanda Connect YAML that writes to staging tables like `{schema}."stg_Actor"` â€” but it assumes the table exists. If migration generation is broken for 36/39 tables, those pipeline inserts will fail at runtime.

---

## 7. Audit: Flags (target_exists, replicate_structure)

> **Plan:** [Phase 1D â€” Table DDL Generation](MIGRATION_IMPLEMENTATION_PLAN.md#1d-table-ddl-generation) (tasks 1D.1, 1D.2)

### 7.1 `target_exists`

Defined in: `cdc_generator/core/service_sink_types.py` (SinkTableConfig TypedDict)

| Value | Meaning | Migration Implication |
|-------|---------|----------------------|
| `false` | Table does NOT exist in target â†’ must be created | Migration should generate `CREATE TABLE` DDL |
| `true` | Table already exists â†’ just map columns | Migration should SKIP DDL (or validate schema matches) |

**Current migration handling: ðŸ”´ None.** The stale migration files don't read this flag.

### 7.2 `replicate_structure`

Defined in: `cdc_generator/core/service_sink_types.py` + `cdc_generator/core/structure_replicator.py`

| Value | Meaning | Migration Implication |
|-------|---------|----------------------|
| `true` | Clone source structure with type mapping | Read source schema, map types (MSSQLâ†’PG), generate DDL |
| `false`/absent | Don't auto-create | Manual DDL or `target_exists: true` |

**The `structure_replicator.py` module exists and works** (550 lines, generates proper DDL), but it is:
- âŒ Not wired into migration generation
- âœ… Used by pipeline generation for `replicate_structure` tables
- It reads from `services/_schemas/` directory (schema YAML files)

### 7.3 What the Adopus Config Uses

```yaml
# Pattern 1: Clone from source (most tables)
adopus.Actor:
  target_exists: false
  replicate_structure: true
  column_templates:
    - template: customer_id
  from: dbo.Actor

# Pattern 2: Map to existing table (custom mapping)
public.customer_user:
  target_exists: true
  from: dbo.Actor
  columns:
    BrukerNavn: brukerBrukerNavn
    ...
```

**All 39 `adopus.*` sink tables use `target_exists: false` + `replicate_structure: true`.**
The 2 `public.*` sink tables use `target_exists: true`.

---

## 8. Audit: Offset Gap Setup

> **Plan:** [Phase 1C â€” Infrastructure SQL](MIGRATION_IMPLEMENTATION_PLAN.md#1c-infrastructure-sql) (centralized in `cdc_management`)

### 8.1 Current State

**ðŸŸ¡ Template exists, not auto-generated per table.**

The `2-cdc-processing-log.sql` creates:
- âœ… `cdc_processing_log` table (tracks offset ranges per table/partition)
- âœ… `v_cdc_processing_gaps` view (detects gaps using LEAD window function)
- âœ… `v_cdc_replication_lag` view (monitors lag per table/partition)
- âœ… `v_cdc_processing_stats` view (batch statistics)

**Gap analysis:** The processing log uses `{{SCHEMA}}` placeholder â€” it must be applied per customer schema. But the application logic was in the deleted script.

### 8.2 Not Implemented

- âŒ No per-table offset initialization SQL
- âŒ No auto-detection of where to resume after a gap
- âŒ No Redpanda offset reset tooling
- âŒ No integration with `manage-migrations` CLI for gap analysis

---

## 9. Audit: Target Schema Creation

> **Plan:** [Phase 1B â€” Schema Creation SQL](MIGRATION_IMPLEMENTATION_PLAN.md#1b-schema-creation-sql)

### 9.1 Current State

**ðŸŸ¡ Static file, not auto-generated.**

`1-create-customer-schemas.sql`:
- âœ… Creates 26 customer schemas (one per customer)
- âŒ Hardcoded â€” does not read from `source-groups.yaml` or service config
- âŒ Adding a new customer requires manual edit + regeneration
- âŒ Does NOT create schemas referenced in sink config (e.g., `public`, `cdc_management`)

### 9.2 Expected Behavior

Schema creation should:
1. Read customers from service config or `source-groups.yaml`
2. Auto-generate `CREATE SCHEMA IF NOT EXISTS` for each customer
3. Also create infrastructure schemas (`cdc_management`)
4. Be re-runnable (idempotent via `IF NOT EXISTS`)

---

## 10. Pattern Comparison (db-per-tenant vs db-shared)

> **Plan:** [Phase 5 â€” Pattern Support (db-shared)](MIGRATION_IMPLEMENTATION_PLAN.md#phase-5-pattern-support-db-shared)

### 10.1 Migration Differences by Pattern

| Aspect | db-per-tenant (adopus) | db-shared (asma) |
|--------|----------------------|------------------|
| Target schemas | 1 per customer (26 schemas) | 1 per service (e.g., `directory`, `chat`) |
| Schema creation | Customer name = schema | Service name = schema |
| Table DDL | Same table replicated N times (per schema) | Table created once per service schema |
| Staging tables | Per schema: `{customer}."stg_Actor"` | Per service: `{service}."stg_customer_user"` |
| Merge procedures | Per schema: `{customer}.sp_merge_actor()` | Per service: `{service}.sp_merge_customer_user()` |
| Customer isolation | Schema-level | `customer_id` column in every table |
| `column_templates` | May add `customer_id` for cross-tenant sinks | Must add `customer_id` for data isolation |
| Placeholder | `{{SCHEMA}}` = customer name | `{{SCHEMA}}` = service name |

### 10.2 What Needs to be Pattern-Aware

The migration generator MUST branch on `pattern`:
- `db-per-tenant`: Extract customer list â†’ one schema per customer
- `db-shared`: Extract service list â†’ one schema per service

---

## 11. Best-Practice Recommendations

> **Plan:** Recommendations mapped to plan phases â€” [Phase 4 (Migration State Tracking)](MIGRATION_IMPLEMENTATION_PLAN.md#phase-4-migration-state-tracking), [Phase 6 (Operational Tooling)](MIGRATION_IMPLEMENTATION_PLAN.md#phase-6-operational-tooling)

> These are additional aspects beyond the user's original questions, identified from industry CDC migration best practices. **Decide which to keep.**

### 11.1 Migration Ordering & Dependencies

**Issue:** Current prefix system (`0-`, `1-`, `2-`, etc.) encodes execution order but has no dependency tracking.

**Recommendation:**
- Use a proper migration manifest (YAML or SQL header) declaring dependencies
- Ensure `CREATE TABLE` runs before staging table `LIKE` clause
- Ensure `cdc_management` schema exists before triggers reference it

### 11.2 Idempotency

**Issue:** Current SQL uses `IF NOT EXISTS` for tables but `CREATE OR REPLACE` for functions/procedures. Views use `CREATE OR REPLACE`. This is mostly idempotent, but `ALTER TABLE ADD COLUMN` operations (in staging table) use `EXCEPTION WHEN OTHERS THEN NULL` which swallows real errors.

**Recommendation:**
- Replace error-swallowing with explicit `IF NOT EXISTS` column checks
- Use `DO $$ ... ALTER TABLE ... ADD COLUMN IF NOT EXISTS ...` (requires PG 9.6+)

### 11.3 Dry-Run / Plan Mode

**Issue:** No way to preview what migrations will do before running.

**Recommendation:**
- Add `cdc manage-migrations generate --dry-run` that outputs planned SQL without writing files
- Add `cdc manage-migrations diff` that compares existing DDL vs what would be generated

### 11.4 Migration State Tracking

**Issue:** No way to know which migrations have been applied to which customer/schema.

**Recommendation:**
- Create a `cdc_management.migration_history` table
- Record: migration file, applied_at, schema_name, checksum
- Before applying: check if already applied (skip or warn)
- This enables: partial rollouts, retries, audit trails

### 11.5 Rollback Strategy

**Issue:** No rollback mechanism. If a migration fails halfway, the database is in an unknown state.

**Recommendation:**
- Wrap each migration file in a transaction (`BEGIN; ... COMMIT;`)
- Generate corresponding `DOWN` migration (at minimum for `CREATE TABLE â†’ DROP TABLE`)
- For column changes: generate reversible pairs

### 11.6 Type Mapping Consistency

**Issue:** Type mapping between MSSQL and PostgreSQL exists in:
- `services/_schemas/_definitions/map-mssql-pgsql.yaml` (canonical type map)
- `cdc_generator/helpers/type_mapper.py` (Python type mapper)
- `structure_replicator.py` (DDL generator)
- Old script inline mapping (now deleted)

**Recommendation:**
- Single source of truth: use `map-mssql-pgsql.yaml` as the definitive map
- All code should read from this file, not maintain duplicate mappings
- Verify consistency between DDL generation and pipeline field types

### 11.7 CDC Metadata Column Consistency

**Issue:** Final tables include CDC metadata (`__sync_timestamp`, `__source`, etc.) while staging tables use `LIKE ... INCLUDING DEFAULTS` plus additional Kafka columns. The column sets may diverge.

**Recommendation:**
- Define metadata columns in one place (e.g., a template or config)
- Both final and staging table DDL should reference the same definition
- Ensure pipeline INSERT column lists match DDL column lists

### 11.8 Merge Procedure Safety

**Issue:** Current merge procedures do `TRUNCATE ... CASCADE` after merge. If there are foreign keys pointing to staging tables (unlikely but possible with custom setups), CASCADE could cause data loss.

**Recommendation:**
- Use `TRUNCATE ... RESTRICT` (default) instead of CASCADE where stable
- Add a row-count verification step: `COUNT after - COUNT before` = expected

### 11.9 Customer Schema Permissions

**Issue:** `0-cdc-merge-control.sql` grants to `postgres` user only. Customer schemas may need grants to application users, CDC service accounts, etc.

**Recommendation:**
- Make grantee configurable (ENV variable or service config)
- Generate GRANT statements for each customer schema
- Consider using PostgreSQL roles for group permissions

### 11.10 Sink-Specific Migrations

**Issue:** Current migrations only handle the `db-per-tenant` source-side pattern (MSSQL â†’ customer schemas). The sink-side (e.g., `sink_asma.directory`) has different target tables with `target_exists: true` that may need initialization scripts.

**Recommendation:**
- For `target_exists: true` tables: generate validation queries (check table exists, check columns exist)
- For `target_exists: false` + `replicate_structure: true`: generate proper CREATE TABLE DDL using `structure_replicator.py`
- Consider generating sink-specific migration sets (one per sink group)

### 11.11 Concurrent Migration Application

**Issue:** If multiple operators apply migrations simultaneously, there's no locking.

**Recommendation:**
- Use PostgreSQL advisory locks (`pg_advisory_lock`) in migration runner
- Or use a migration state table with pessimistic locking

### 11.12 Generated File Checksums

**Issue:** No way to detect if generated files were manually edited (violating "DO NOT EDIT" header).

**Recommendation:**
- Include a SHA256 checksum in the file header comment
- Before regeneration: compare checksums, warn if modified
- This also enables detecting when regeneration is actually needed

---

## 12. Action Plan

> **Detailed implementation plan:** [MIGRATION_IMPLEMENTATION_PLAN.md](MIGRATION_IMPLEMENTATION_PLAN.md)
> The plan below is the original rough outline. The implementation plan expands each phase into tracked tasks with acceptance criteria.

### Phase 1: Restore Core Migration Generation

Priority: **P0 â€” Blocking all other migration work**

| Task | Description | Code Location |
|------|-------------|---------------|
| 1.1 | Create `cdc_generator/core/migration_generator.py` | New file |
| 1.2 | Implement table-definition YAML generation from MSSQL inspection | Uses `schema_docs.py` introspection + `source.tables` config |
| 1.3 | Implement final table DDL generation â†’ `migrations/tables/` | Uses `structure_replicator.py` patterns |
| 1.4 | Implement staging table + merge procedure generation â†’ `migrations/staging/` | Port from stale SQL templates |
| 1.5 | Implement customer schema SQL generation â†’ `migrations/schemas/` | Read customers from source-groups.yaml |
| 1.6a | Generate infrastructure SQL â†’ `migrations/infrastructure/` | Port merge-control + processing-log |
| 1.6 | Wire into `MIGRATION_COMMANDS` dict and Click CLI | `commands.py` + `click_commands.py` |
| 1.7 | Integrate service config: read `ignore_columns`, `target_exists`, `replicate_structure` | `services/{service}.yaml` |

### Phase 2: Fix CLI Routing

Priority: **P0 â€” Enable existing subcommands**

| Task | Description |
|------|-------------|
| 2.1 | Add `enable-cdc`, `apply-replica`, `clean-cdc` to `MIGRATION_COMMANDS` dict â€” OR â€” remove dead Click registrations |
| 2.2 | Add `generate` subcommand (the core migration generation command) |
| 2.3 | Decide: should `schema-docs` stay in manage-migrations or move to manage-services? |

### Phase 3: Schema Evolution

Priority: **P1 â€” Required before production**

| Task | Description |
|------|-------------|
| 3.1 | Implement schema diff (compare MSSQL source vs existing PG target) |
| 3.2 | Generate incremental `ALTER TABLE` statements |
| 3.3 | Add migration state tracking table (`cdc_management.migration_history`) |
| 3.4 | Add dry-run mode |

### Phase 4: Pattern Support

Priority: **P1 â€” Required for asma (db-shared)**

| Task | Description |
|------|-------------|
| 4.1 | Make migration generator pattern-aware (`pattern`) |
| 4.2 | Test with asma (`db-shared`) service config |
| 4.3 | Generate service-based schemas instead of customer-based for db-shared |

### Phase 5: Operational Tooling

Priority: **P2 â€” Quality of life**

| Task | Description |
|------|-------------|
| 5.1 | Implement `apply-replica` (apply generated SQL to target PG) |
| 5.2 | Implement `enable-cdc` (enable MSSQL CDC on source tables) |
| 5.3 | Implement `clean-cdc` (clean old CDC tracking data) |
| 5.4 | Add `--dry-run`, `--diff`, `--check` flags |
| 5.5 | Add migration checksums for edit detection |

---

## Appendix A: File Reference

| File | Location | Purpose |
|------|----------|---------|
| `cdc_generator/cli/commands.py` | Generator | `MIGRATION_COMMANDS` dict (only `schema-docs`) |
| `cdc_generator/cli/click_commands.py` | Generator | Click CLI group (4 subcommands, 3 broken) |
| `cdc_generator/cli/schema_docs.py` | Generator | MSSQL introspection â†’ YAML (works) |
| `cdc_generator/core/structure_replicator.py` | Generator | DDL generation for `replicate_structure` (works, not wired to migrations) |
| `cdc_generator/core/pipeline_generator.py` | Generator | Pipeline YAML generation (reads table-definitions) |
| `cdc_generator/helpers/helpers_batch.py` | Generator | Staging INSERT routing YAML (references `stg_*` tables) |
| `cdc_generator/core/service_sink_types.py` | Generator | TypedDict for `target_exists`, `replicate_structure` |
| `cdc_generator/validators/manage_service/sink_operations.py` | Generator | `TableConfigOptions` dataclass with migration-relevant flags |
| `cdc_generator/helpers/type_mapper.py` | Generator | MSSQL â†’ PostgreSQL type mapping |
| `services/_schemas/_definitions/map-mssql-pgsql.yaml` | Generator | Canonical type mapping YAML |
| `services/adopus.yaml` | Adopus impl | Service config (39 source tables, sink mappings) |
| `source-groups.yaml` | Adopus impl | Server group config (customers, extraction pattern) |
| `sink-groups.yaml` | Adopus impl | Sink group config (target PG servers) |
| `generated/pg-migrations/*.sql` | Adopus impl | **STALE** â€” to be replaced by `migrations/` (3 of 39 tables) |
| `migrations/` | Adopus impl | **NEW** top-level output for `manage-migrations generate` |
| `generated/table-definitions/*.yaml` | Adopus impl | Stale table definitions (3 of 39 tables) |
| `_docs/architecture/EVENT_DRIVEN_MERGE_SYSTEM.md` | Generator | Docs for the merge control system |
