# Development Container - Full CDC Development Environment
# Includes Python + MSSQL CLI + PostgreSQL + Fish shell + All Dependencies
FROM python:3.13-slim

# Install system dependencies, MSSQL tools, PostgreSQL client, and Fish shell
RUN apt-get update && apt-get install -y \
    curl \
    gnupg2 \
    apt-transport-https \
    ca-certificates \
    postgresql-client \
    fish \
    git \
    vim \
    docker.io \
    libatomic1 \
    unzip \
    && curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o /usr/share/keyrings/microsoft-prod.gpg \
    && curl https://packages.microsoft.com/config/debian/12/prod.list | tee /etc/apt/sources.list.d/mssql-release.list \
    && apt-get update \
    && ACCEPT_EULA=Y apt-get install -y \
        mssql-tools18 \
        unixodbc-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Redpanda Connect CLI (rpk) for Bloblang validation
RUN curl -LO https://github.com/redpanda-data/redpanda/releases/latest/download/rpk-linux-amd64.zip \
    && unzip rpk-linux-amd64.zip \
    && chmod +x rpk \
    && mv rpk /usr/local/bin/ \
    && rm rpk-linux-amd64.zip

# Add sqlcmd and workspace bin to PATH
ENV PATH="/opt/mssql-tools18/bin:/workspace:${PATH}"

# Set working directory
WORKDIR /workspace

# Copy ONLY pyproject.toml to install dependencies (not the package itself yet)
COPY pyproject.toml setup.py ./

# Install Python dependencies WITHOUT installing the package yet
# This includes all runtime dependencies, dev dependencies, and type stubs
RUN pip install --no-cache-dir \
    # Core dependencies (from pyproject.toml)
    pyyaml>=6.0 \
    jinja2>=3.1 \
    # Database drivers (full installation)
    pymssql>=2.2 \
    psycopg2-binary>=2.9 \
    # Additional utilities
    ruamel.yaml \
    pyodbc \
    pgcli \
    # Development tools
    pytest>=7.0 \
    black>=23.0 \
    ruff>=0.1 \
    mypy>=1.0 \
    pyright>=1.1 \
    pylint \
    # Type stubs for static type checking
    types-PyYAML \
    types-pymssql

# NOTE: The actual package installation happens at runtime via docker-entrypoint.sh
# This ensures we always use the latest code from the volume-mounted /workspace

# Set Python to unbuffered mode for better logging
ENV PYTHONUNBUFFERED=1

# Create Fish config directory
RUN mkdir -p /root/.config/fish/completions

# Copy Fish completions for cdc command (single source of truth from template)
COPY cdc_generator/templates/init/cdc.fish /usr/share/fish/vendor_completions.d/cdc.fish

# Copy entrypoint script
COPY docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Set Fish as default shell for root user
RUN chsh -s /usr/bin/fish root

# Auto-reload completions on every shell start (always use latest)
RUN echo '# Auto-reload completions from workspace on shell start' >> /root/.config/fish/config.fish \
    && echo 'if test -f /workspace/cdc_generator/templates/init/cdc.fish' >> /root/.config/fish/config.fish \
    && echo '    cp /workspace/cdc_generator/templates/init/cdc.fish /usr/share/fish/vendor_completions.d/cdc.fish 2>/dev/null' >> /root/.config/fish/config.fish \
    && echo 'end' >> /root/.config/fish/config.fish \
    && echo '' >> /root/.config/fish/config.fish

# Add reload alias for immediate completion updates during development
RUN echo 'alias reload-completions="cp /workspace/cdc_generator/templates/init/cdc.fish /usr/share/fish/vendor_completions.d/cdc.fish && source /usr/share/fish/vendor_completions.d/cdc.fish && echo âœ… Completions reloaded!"' >> /root/.config/fish/config.fish

# Auto-launch fish when bash is started (for docker compose exec dev bash)
RUN echo 'exec fish' >> /root/.bashrc

# Set Fish as default shell
ENV SHELL=/usr/bin/fish
SHELL ["/usr/bin/fish", "-c"]

# Set entrypoint to ensure package is always installed
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]

# Default command - keep container running
CMD ["tail", "-f", "/dev/null"]
